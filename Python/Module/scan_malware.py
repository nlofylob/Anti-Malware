import os
import hashlib
import io

#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#

def Scan_Size(mSize_db, inputFile) :
    inputSize = os.path.getsize(inputFile)

    if mSize_db.count(inputSize) :
        return True
    
    return False

def Scan_MD5(m_db, inputBuf) :
    md5 = hashlib.md5()
    md5.update(inputBuf)
    fMD5 = md5.hexdigest()

    for temp in m_db :
        if fMD5 == temp[0] :
            print("( + ) Detected By MD5")
            return True, temp[1]
    
    return False, ''

def Scan_Signature_Part(m_db, inputBuf) :
    inputBuf = io.BytesIO(inputBuf)

    for temp in m_db :
        m_offset = temp[0]
        m_signature = temp[1]

        readSize = len(m_signature)
        inputBuf.seek(m_offset)
        readBuf = (inputBuf.read(readSize)).decode('UTF-8') # Type Change : from Byte to String

        if readBuf == m_signature :
            print("( + ) Detected By Signature (Part)")
            return True, temp[2]
        
        return False, ''

#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#

def Scan_Malware(mSize_db, m_db, inputFile) :
    result = False
    mName = ''

    result_scanSize = Scan_Size(mSize_db, inputFile)
    if result_scanSize == True :
        fHandle = open(inputFile, 'rb')
        fBuf = fHandle.read()
        fHandle.close()

        # Malware Scan 1. MD5
        result, mName = Scan_MD5(m_db, fBuf)
        if result == True :
            return result, mName
        
        # Malware Scan 2. Signature
        result, mName = Scan_Signature_Part(m_db, fBuf)
        if result == True :
            return result, mName
        
    return result, mName
