import os
import sys
import hashlib
import zlib

NYDB_PATH = '../../DB/NYDB/'

def EncryptNY() :

    # Command Line
    if len(sys.argv) != 2 :
        print('How to Use : encrypt.py [file]')
        exit(0)
    
    fName = sys.argv[1]

    fHandle = open(fName, 'rb')
    fBuf = fHandle.read()
    fHandle.close()

    print("%%%%%%%% TEST : (1) Original (.db) %%%%%%%%")
    print(fBuf)
    print("Original (.db) - File Type : {type}".format(type = type(fBuf)))
    print()

    # 1. Compress
    fCompressed = zlib.compress(fBuf)
    print("%%%%%%%% TEST : (2) Compress %%%%%%%%")
    print(fCompressed)
    print("After Compress - File Type : {type}".format(type = type(fCompressed)))
    print()

    # 2-1. Encrypt : XOR
    """
    fEncrypted = ''
    for i in fCompressed :
        fEncrypted += chr(i ^ 0xFF)
    """
    #"""
    fEncrypted = bytearray([i ^ 0xFF for i in fCompressed])
    #"""
    print("%%%%%%%% TEST : (3-1) Encrypt %%%%%%%%")
    print(fEncrypted)
    print("After Encrypt - File Type : {type}".format(type = type(fEncrypted)))
    print()
    """
    
    # 2-2. Decrypt : XOR
    """
    fDecrypted = ''
    for i in fEncrypted :
        fDecrypted += chr(i ^ 0xFF)
    """
    #"""
    fDecrypted = bytearray([i ^ 0xFF for i in fEncrypted])
    #"""
    print("%%%%%%%% TEST : (3-2) Decrypt %%%%%%%%")
    print(fDecrypted)
    print("After Decrypt - File Type : {type}".format(type = type(fDecrypted)))
    print()

    # Create File Format : ny - Header / Body
    HEADER = b'NYAM' # Type :  Byte
    BODY = fEncrypted # Type : Byte

    # Create File Format : ny - ALL
    ny = HEADER + BODY # Type : Byte
    fMD5x4 = ny
    for i in range(4) :
        md5 = hashlib.md5()
        md5.update(fMD5x4)
        fMD5x4 = md5.hexdigest().encode('UTF-8') # Type Change : from String to Byte
    print("#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#")
    print("File MD5 : {md5}".format(md5 = fMD5x4))
    print("#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#=#")
    print()
    ny += fMD5x4

    fName_base = os.path.basename(fName)
    ny_name = fName_base.split('.')[0] + '.ny'
    ny_path = NYDB_PATH + ny_name
    fHandle = open(ny_path, 'wb')
    fHandle.write(ny)
    fHandle.close()

    print('[ Result : encrypt.py ] {before} => => => => {after}'.format(before = fName, after = ny_name))

if __name__ == '__main__' :
    EncryptNY()
